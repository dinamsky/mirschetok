!function(o){o.sdekint=o.sdekint||{},o.extend(o.sdekint,{data:null,stopDispatchIndex:0,previousHash:"",init:function(t){this.data=t||{},this.$sidebar=o("#sdekint-sidebar"),this.$content=o("#s-sdekint-content"),o("#mainmenu").find("li.s-plugin-sdekint").removeClass("no-tab").addClass("selected"),void 0!==o.History&&o.History.bind(function(){this.dispatch()}.bind(this));var e=window.location.hash;"#/"!==e&&e?o.wa.setHash(e):this.dispatch()},_selectSidebarAction:function(t){var e=this.$sidebar.find("ul.sdekint-menu li[data-action]");e.removeClass("selected"),e.filter('[data-action="'+t+'"]').addClass("selected")},dispatch:function(t){if(0<this.stopDispatchIndex)return this.stopDispatchIndex--,!1;if(void 0===t&&(t=window.location.hash),!t){var e=this.$sidebar.find("ul.sdekint-menu:first").find("li:first > a:first");e.length&&(window.location.hash=t=e.attr("href"))}if(this.previousHash!==t){t=(this.previousHash=t).replace(/^[^#]*#\/*/,"");try{var i=function(t){if(!t)throw{message:"Invalid path",data:t};return-1===(t=t.replace(/^.*#\//,"")).indexOf("/")&&(t+="/"),{action:t.replace(/\/.*$/,"")||null,tail:t.replace(/^[^\/]+\//,"").replace(/[\w_\-]+=.*$/,"").replace(/\/$/,"")||null,raw:t}}(t);if(!(i.action&&i.action.length&&this[i.action+"Action"]))throw{message:"Invalid action name: "+(i.action||"{empty}")+"Action",data:i.action||null};this[i.action+"Action"](i.tail)}catch(t){o.shop.trace(t.message,t.data)}}},calculatorAction:function(){this._selectSidebarAction("calculator"),o.shop.getJSON("?plugin=sdekint&module=calculator",function(t){this.$content.html(t.data.html);new o.sdekint.Calculator(this.data)}.bind(this))},officesAction:function(){this._selectSidebarAction("offices"),o.shop.getJSON("?plugin=sdekint&module=office",function(t){this.$content.html(t.data.html);new o.sdekint.Office(this.data)}.bind(this))},couriercallsAction:function(t){this._selectSidebarAction("couriercalls");var i={};(t=t||"").split("/").forEach(function(t){var e=t.split(":");i[e[0]]=e[1]||null}),o.shop.getJSON("?plugin=sdekint&module=courier&action=calls",i,function(t){this.$content.html(t.data.html);new o.sdekint.CourierCalls}.bind(this))},pickupAction:function(){this._selectSidebarAction("pickup");var t=o.storage.get("shop/sdekint/courier-call")||{};o.shop.getJSON("?plugin=sdekint&module=courier&action=pickup",{stored:t},function(t){this.$content.html(t.data.html);new o.sdekint.Pickup(this.data,t.data.order)}.bind(this))},orderactionsAction:function(){function s(){return o.shop.getJSON("?plugin=sdekint&module=orderactions",function(t){var e,i=o("#s-plugin-sdekint-rule-list"),n=o(t.data.html);if(i.length){var s=n.find("#s-plugin-sdekint-rule-list");s.find("tbody tr").length?(e=s.html(),i.html(e)):(e=n.find("#s-plugin-sdekint-rule-list-container").html(),o("#s-plugin-sdekint-rule-list-container").html(e))}else e=n.find("#s-plugin-sdekint-rule-list-container").html(),o("#s-plugin-sdekint-rule-list-container").html(e)})}this._selectSidebarAction("orderactions"),o.shop.getJSON("?plugin=sdekint&module=orderactions",function(t){this.$content.html(t.data.html),this.$content.off().on("click","a.js-action[data-action=edit]",function(t){return function(i){new o.sdekint.Dialog({html:o("#EditOrderactionDialog").render({rule_id:i}),onOpen:function(t,e){o.shop.getJSON("?plugin=sdekint&module=orderactions&action=edit",{id:i||0},function(t){e.$block.find(".sdekint-dialog-content").html(t.data.html),e.resize({width:550,height:300}),e.$block.find("footer button, footer input[type=button], footer a[disabled]").prop("disabled",!1);var i=e.$block.find("footer button[type=submit], footer input[type=submit], footer button.submit");e.$block.on("change","#s-plugin-sdekint-rule-current-store-state-select",function(t){var e=o(t.currentTarget),i=e.val(),n=o("#s-plugin-sdekint-rule-action-select"),s=n.closest("div.field").find("span.loading");n.empty().val(0).prop("disabled",!0),s.show(),o.sdekint.Http.loadAvailableWorkflowActions(i,function(t){t.data.actions.length&&(o.each(t.data.actions,function(t,e){n.append(o("<option></option>").val(e.id).text(e.name))}),n.prop("disabled",!1))}).always(function(){s.hide(),e.trigger("check_submit")})}).on("check_submit",function(){var e=!0;o("#s-plugin-sdekint-rule-current-store-state-select, #s-plugin-sdekint-rule-current-sdek-state-select, #s-plugin-sdekint-rule-action-select").each(function(){var t=o(this);t.val()&&t.find('option[value="'+t.val()+'"]').length||(e=!1)}),i.prop("disabled",!e)}).on("click","footer button[type=submit], footer input[type=submit], footer button.submit",function(){o.sdekint.Http.saveOrderAction(e.$block.find("form").serialize()).always(function(){s().done(function(){e.close()})})}).trigger("check_submit")})}})}(o(t.currentTarget).data("id")),!1}).on("click","a.js-action[data-action=delete]",function(t){var i=o(t.currentTarget),n=i.closest("tbody");new o.sdekint.Dialog({html:o("#DeleteOrderactionDialog").render({message:i.data("js-confirm")||"Вы уверены?"}),onOpen:function(t,e){e.$block.on("click",".red.submit",function(){var t=i.closest("tr[data-id]");o.sdekint.Http.deleteOrderAction(t.data("id"),function(){t.remove(),n.find("tr").length||s(),e.close()})})}});return!1})}.bind(this))},calccontrolAction:function(){this._selectSidebarAction("calccontrol"),o.shop.getJSON("?plugin=sdekint&module=shipping",function(t){this.$content.html(t.data.html),this.$content.off().on("click","a[data-js-action=delete]",function(t){var n=o(t.currentTarget),s=n.closest("tr[data-id]");new o.sdekint.Dialog({html:o("#DeleteRuleDialog").render({message:n.data("js-confirm")||"Вы уверены?"}),onOpen:function(t,i){i.$block.on("click",".red.submit",function(){o.sdekint.Http.deleteCalcRule(s.data("id"),function(){var t=n.closest("table");s.remove();var e=o("#sdekint-rules-list");e.find(".pagination ul li").length?window.location.reload():(i.close(),t.find("tr[data-id]").length||e.empty())})})}});return!1}.bind(this))}.bind(this))},widgetcontrolAction:function(t){this._selectSidebarAction("widgetcontrol");var e={};t&&(e=t.split("/").reduce(function(t,e){var i=e.split(":",2);return i.length<2&&(i[1]=i[0]),t[i[0]]=i[1],t},{})),o.shop.getJSON("?plugin=sdekint&module=widget",e,function(t){this.$content.html(t.data.html),this.$content.off().on("click","a[data-js-action=delete]",function(t){var e=o(t.currentTarget),i=e.closest("tr[data-id]");new o.sdekint.Dialog({html:o("#DeleteWidgetConfigDialog").render({message:e.data("js-confirm")||"Вы уверены?"}),onOpen:function(t,e){e.$block.on("click",".red.submit",function(){o.sdekint.Http.deleteWidgetConfig(i.data("id"),function(){i.remove(),o("#widget_list").find(".pagination ul li").length?window.location.reload():e.close()})})}});return!1}.bind(this))}.bind(this))},widgetEditAction:function(t){this._selectSidebarAction("widgetcontrol");var n=function(){var t=this.$content.find(".sdekint-widget-edit-form").find('input[name="widget[id]"]').val(),e=this.$content.find("#sdekint-code-sample");!e.find("pre").length&&t&&(e.html(o("#CodeBlock").render({id:t})),prettyPrint())}.bind(this);o.shop.getJSON("?plugin=sdekint&module=widget&action=edit",{id:t},function(t){this.$content.html(t.data.html);this.$content;n(),this.$content.off().on("click","a.back",function(){return window.history.go(-1),!1}).on("submit",".sdekint-widget-edit-form",function(t){o(t.currentTarget);var e=o(this),i=e.find(".field.submit .value i.loading");return i.show(),o.shop.jsonPost(e.attr("action"),e.serialize(),function(t){t.data&&t.data.id&&e.find('input[name="widget[id]"]').val(t.data.id),n(),i.closest("div").append('<span class="success state successmsg" style="display: inline-block;">Сохранено</span>'),setTimeout(function(){var t=i.closest("div").find("span.state");t.fadeOut(400).always(function(){t.remove()})},3e3)}).always(function(){i.hide()}),!1})}.bind(this))}})}(jQuery),$.extend($.sdekint,{Http:{deleteOrderAction:function(t,e,i){return $.shop.jsonPost("?plugin=sdekint&module=orderactions&action=delete",{id:t},e,i)},deleteCalcRule:function(t,e,i){return $.shop.jsonPost("?plugin=sdekint&module=shipping&action=delete",{id:t},e,i)},deleteWidgetConfig:function(t,e,i){return $.shop.jsonPost("?plugin=sdekint&module=widget&action=delete",{id:t},e,i)},deletePickup:function(t,e,i,n){return $.shop.jsonPost("?plugin=sdekint&module=courier&action=dismissPickup",{data:JSON.stringify({order_no:t,number_ttn:e})},i,n)},loadAvailableWorkflowActions:function(t,e,i){return $.shop.getJSON("?plugin=sdekint&module=orderactions&action=availableActions",{state_id:t},e,i)},loadPointsByCity:function(t,e,i,n){var s={city_code:t};return e?s.page=1:s.nolimit=1,$.shop.getJSON("?plugin=sdekint&module=office&action=index",s,i||function(t){},n||function(t){})},loadRegions:function(t,e,i){return $.shop.getJSON("?plugin=sdekint&module=geography&action=regions",{country:t},e,i)},saveOrderAction:function(t,e,i){return $.shop.jsonPost("?plugin=sdekint&module=orderactions&action=save",t,e,i)},pickup:{save:function(t,e,i){return $.shop.jsonPost("?plugin=sdekint&module=courier&action=pickup",{data:JSON.stringify(t)},e,i)}}}}),function(i){i.sdekint=i.sdekint||{},i.extend(i.sdekint,{Select2:{formatCities:function(t){return t&&t.status&&"ok"===t.status&&t.data&&i.isArray(t.data)?{results:i.map(t.data,function(t){return t.text=i.sdekint.Select2.readableCity(t,!0),t.id=t.sdek_id,t})}:{results:[]}},readableCity:function(t,e){if(!t||!t.name||!t.Country)return"";var i=[];return i.push(t.name),t.Region&&t.Region.name&&t.name.toLowerCase()!==t.Region.name.toLowerCase()&&i.push(t.Region.name),e||i.push(t.Country.name),i.join(", ")},countryOptions:function(t){return i.map(t,function(t){return{id:t.iso3letter,text:t.name}})},formatCountry:function(t,e){return t.id||(t.id="--"),i('<span><img src="'+e+"wa-content/img/country/"+t.id+'.gif" class="img-flag" /> '+t.text+"</span>")}}})}(jQuery),function(i){i.sdekint=i.sdekint||{},i.sdekint.Utils={numberFormat:function(t,e){if(!t||isNaN(+e))return e;var i,n,s,o,a,r,d,c,l,u,h=t.length,f=t.search(/[0-9\-+#]/),p=0<f?t.substring(0,f):"",m=t.split("").reverse().join(""),g=m.search(/[0-9\-+#]/),k=h-g,v=k+("."===t.substring(k,k+1)?1:0),y=0<g?t.substring(v,h):"";if(i=(e="-"===(t=t.substring(f,v)).charAt(0)?-e:+e)<0?e=-e:0,s=(n=t.match(/[^\d\-+#]/g))&&n[n.length-1]||".",o=n&&n[1]&&n[0]||",",t=t.split(s),e=+(e=e.toFixed(t[1]&&t[1].length))+"",r=t[1]&&t[1].lastIndexOf("0"),(!(c=e.split("."))[1]||c[1]&&c[1].length<=r)&&(e=(+e).toFixed(r+1)),l=t[0].split(o),t[0]=l.join(""),-1<(a=t[0]&&t[0].indexOf("0")))for(;c[0].length<t[0].length-a;)c[0]="0"+c[0];else 0==+c[0]&&(c[0]="");if((e=e.split("."))[0]=c[0],d=l[1]&&l[l.length-1].length){for(m="",k=(u=e[0]).length%d,h=u.length,v=0;v<h;v++)m+=u.charAt(v),!((v-k+1)%d)&&v<h-d&&(m+=o);e[0]=m}return e[1]=t[1]&&e[1]?s+e[1]:"","0"!==(n=e.join(""))&&""!==n||(i=!1),p+(i?"-":"")+n+y},fixDec:function(t){return("string"==typeof t||t instanceof String)&&(t=t.replace(",",".")),t},formatIntNumber:function(t,e){return e=_.toInteger(e||0),_.toInteger(i.sdekint.Utils.fixDec(t))||e},formatNumber:function(t,e){return e=_.toNumber(e||0),_.toNumber(i.sdekint.Utils.fixDec(t))||e},monetary:function(t){return i.sdekint.Utils.numberFormat("# ##0,00",t)}}}(jQuery),function(s){s.sdekint=s.sdekint||{},s.sdekint.Ymaps={load:function(){return s.Deferred(function(t){"undefined"!=typeof ymaps&&void 0!==ymaps.Map?ymaps.ready(t.resolve):s.getScript("https://api-maps.yandex.ru/2.1/?lang=ru_RU",function(){ymaps.ready(t.resolve)})})},geocodeSdekPoints:function(t,i){var n=new ymaps.Clusterer({preset:"islands#darkgreenClusterIcons"});return s.each(t,function(t,e){n.add(new ymaps.Placemark([s.sdekint.Utils.formatNumber(e.coord_y),s.sdekint.Utils.formatNumber(e.coord_x)],{point_id:e.code,balloonContentHeader:e.name,balloonContent:i.render(e)},{preset:"islands#darkgreenDotIcon"}))}),n}}}(jQuery),$.sdekint=$.sdekint||{},$.extend($.sdekint,{Dialog:function(t){this.$wrapper=$(t.html),this.$block=!1,this.is_full_screen=this.$wrapper.hasClass("is-full-screen"),this.is_full_screen&&(this.$block=this.$wrapper.find(".sdekint-dialog-block")),this.position=t.position||!1,this.is_closed=!1,this.userPosition=t.setPosition||!1,this.onBgClick=t.onBgClick||!1,this.onOpen=t.onOpen||function(){},this.onClose=t.onClose||function(){},this.onRefresh=t.onRefresh||!1,this.onResize=t.onResize||!1,this.canBeClosed=t.canBeClosed||function(){return!0},this.initClass=function(){this.$wrapper.data("sdekintDialog",this),this.show(),this.bindEvents()},this.bindEvents=function(){var t=$(document),e=this.$block?this.$block:this.$wrapper,i=function(){if(!this.is_closed&&this.canBeClosed())this.close();else if(!this.canBeClosed())return;t.off("click",i),t.off("wa_before_load",i)}.bind(this),n=function(){$.contains(document,this.$wrapper[0])?this.resize():$(window).off("resize",n)}.bind(this);setTimeout(function(){t.on("click",i).on("wa_before_load",i),this.$wrapper.on("close",i),this.is_full_screen&&this.$wrapper.on("click",".sdekint-dialog-background",function(t){this.onBgClick?this.onBgClick(t):t.stopPropagation()}.bind(this)),e.on("click",function(t){t.stopPropagation()}),t.on("keyup",function(t){27===t.keyCode&&this.close()}.bind(this)),e.on("click",".js-close-dialog",function(){i()}),this.is_full_screen&&$(window).on("resize",n)}.bind(this),0)},this.show=function(){$("body").append(this.$wrapper),this.setPosition(),this.onOpen(this.$wrapper,this)},this.setPosition=function(t){var e,i=$(window),n=i.width(),s=this.is_full_screen?i.height():$(document).height(),o=this.$block?this.$block:this.$wrapper,a=t&&t.width?t.width:o.outerWidth(),r=t&&t.height?t.height:o.outerHeight();this.position?e=this.position:e=(this.userPosition?this.userPosition:function(t){return{left:Math.ceil((parseInt((""+n).trim())-parseInt((""+t.width).trim()))/2),top:Math.ceil((parseInt((""+s).trim())-parseInt((""+t.height).trim()))/2)}})({width:a,height:r});if(0<e.left&&e.left+a>n&&(e.left=n-a-10),0<e.top)e.top+r>s&&(e.top=s-r-10);else if(e.top=10,this.is_full_screen){var d=o.find(".sdekint-dialog-content");d.hide();var c=o.outerHeight(),l=s-c-20;d.height(l).addClass("is-long-content").show()}return t?$.extend(e,{width:t.width+"px",height:t.height+"px"}):$.extend(e,{width:o.css("width"),height:o.css("height")}),o.css(e),this},this.close=function(){this.canBeClosed()&&(this.is_closed=!0,this.$wrapper.remove(),this.onClose(this.$wrapper,this))},this.refresh=function(){this.onRefresh&&(this.onRefresh(),this.close())},this.resize=function(t){this.$block.addClass("is-animated"),this.setPosition(t),this.onResize&&this.onResize(this.$wrapper,this)},this.initClass()}}),function(r){r.sdekint=r.sdekint||{},r.sdekint.calcruleAction=function(t){var e=(t=t||"0").split("/")[0]||0;function s(t,e){var i=function(t,e){return e.find(".sdekint-"+t+"-rule").first()}(t,e),n={disabled:i.find(".sdekint-disable-variant-cbx").is(":checked")?1:0,type:"asis",setting:{}};if(n.disabled)return n;if(n.type=i.find(".sdekint-price-type-select").val(),"asis"==n.type)return n;switch(n.type){case"fixed":return n.setting={value:i.find(".value.sdekint-price-type-fixed input").val()},n;case"formula":return n.setting={value:i.find(".value.sdekint-price-type-formula input").val()},n;case"grid":n.setting=function(t){var e={unit:t.find(".sdekint-grid-unit-select").val(),grid:[]};return t.find("tbody tr").each(function(){var t=r(this);e.grid.push({condition:t.find(":input.sdekint-grid-condition").val(),price:t.find(":input.sdekint-grid-price").val()})}),e}(i.find(".sdekint-price-type-grid").first())}return n}r.shop.getJSON("?plugin=sdekint&module=shipping&action=rule",{id:e},function(t){this.$content.html(t.data.html),this.$content.off().on("click","a.back",function(){return window.history.go(-1),!1}),r(".sdekint-rule-form").off().on("change",".sdekint-price-type-select",function(t){var e=r(t.currentTarget).closest("div.field");e.find("div.value.sdekint-price-type").hide(),e.find("div.value.sdekint-price-type-"+this.value).show()}).on("change",".sdekint-disable-variant-cbx",function(t){var e=r(t.currentTarget);e.closest("div.fields").find(">div.field:not(.sdekint-status)").toggle(!e.is(":checked"))}).on("change",".sdekint-grid-unit-select",function(t){var e=r(t.currentTarget),i="price"===e.val()?{name:"Стоимость",value:"р."}:{name:"Вес",value:"кг."},n=e.closest("div.value.sdekint-price-type-grid");n.find(".unit-label").text(i.name),n.find(".unit-value").text(i.value)}).on("click",".sdekint-grid-add-row",function(t){var e=r(t.currentTarget).closest("div.value.sdekint-price-type-grid"),i=e.find("table.sdekint-tariff-grid"),n=e.find(":input.sdekint-grid-unit-select").val(),s=i.find("tbody"),o=s.find("tr").last().clone(),a=o.find(":input.sdekint-grid-condition");return a.val((_.toNumber(a.val().replace(",","."))||0)+("weight"===n?.5:500)),s.append(o),i.trigger("row-count-change"),!1}).on("row-count-change",".sdekint-tariff-grid",function(t){var e=r(t.currentTarget).find("tbody");return e.find(".sdekint-grid-delete-row").toggle(1<e.find("tr").length),!1}).on("click","table.sdekint-tariff-grid tbody .sdekint-grid-delete-row",function(t){var e=r(t.currentTarget),i=e.closest("tbody");return 1<i.find("tr").length&&e.closest("tr").remove(),i.trigger("row-count-change"),!1}).on("change",".sdekint-rule-condition-select",function(t){var e=r(t.currentTarget),i=e.closest(".sdekint-rule-conditions-list-item");i.find(".condition-type").hide();var n=i.find(".condition-type-"+e.val());if(n.show(),"city_sdek"===e.val()){var s=n.find("select.condition-type-city_sdek-city-select").first();if(s.hasClass("select2-hidden-accessible"))return;var o=n.find(".condition-type-city_sdek-country-select");s.select2({theme:"sdekint",ajax:{url:"?plugin=sdekint&module=cities&action=index",data:function(t){return{country:o.val(),term:t.term}},delay:350,processResults:r.sdekint.Select2.formatCities},minimumInputLength:2}).on("select2:opening",function(){setTimeout(function(){r("html,body").trigger("scroll")},1)})}}).on("click",".sdkint-add-rule-condition",function(){var t=r(r("#ConditionItem").render()),e=t.find(".sdekint-rule-condition-select option").first().attr("value");return t.find(".condition-type").hide(),t.find(".condition-type-"+e).show(),r(".sdekint-rule-conditions-list").append(t).trigger("conditions-list-change"),!1}).on("conditions-list-change",".sdekint-rule-conditions",function(t){var e=r(t.currentTarget),i=e.find(".sdekint-rule-conditions-join-type-select"),n=e.find(".sdekint-rule-conditions-list-container"),s=n.find(".sdekint-rule-conditions-list .sdekint-rule-conditions-list-item").length;i.closest("div.value").toggle(1<s),n.toggleClass("multiple-conditions",1<s)}).on("click",".sdekint-rule-condition-delete",function(t){var e=r(t.currentTarget),i=e.closest(".sdekint-rule-conditions-list");return e.closest(".sdekint-rule-conditions-list-item").remove(),i.trigger("conditions-list-change"),!1}).on("change",".sdekint-rule-conditions-join-type-select",function(t){var e=r(t.currentTarget);e.closest(".sdekint-rule-conditions").find(".sdekint-rule-conditions-list-container .sdekint-rule-conditions-list").toggleClass("or","or"===e.val())}).on("change",".condition-type-region-country-select",function(t){var e=r(t.currentTarget),i=e.closest(".condition-type-region").find(".condition-type-regions-region-wrapper"),n=i.find("select.condition-type-regions-region"),s=i.find("input.condition-type-regions-region"),o=i.find(".loading");n.empty(),o.show(),r.sdekint.Http.loadRegions(e.val(),function(t){t.data.length?(n.show(),s.hide(),r.each(t.data,function(t,e){n.append(new Option(e.name,e.code))})):(n.hide(),s.show())}).always(function(){o.hide()})}).on("change",".condition-type-city_name-country-select",function(t){var e=r(t.currentTarget),i=e.closest(".condition-type-city_name"),n=i.find(".condition-type-city_name-region-wrapper"),s=i.find(".condition-type-city_name-region-select"),o=n.find(".loading");"0"!=e.val()?(o.show(),r.sdekint.Http.loadRegions(e.val(),function(t){t.data.length?(s.empty(),s.append(new Option("неважно","")),r.each(t.data,function(t,e){s.append(new Option(e.name,e.code))}),n.show()):n.hide()}).always(function(){o.hide()})):n.hide()}).on("change",":input[name=methods_select]",function(){var t=r(this);t.closest(".field").find(".methods-list").toggle("all"!==t.val())}).on("submit",function(){var i=r(this),n={conditions:[]},t=i.find(":input[name=id]").val();t&&(n.id=t),n.status=i.find(":input[name=status]").is(":checked")?1:0,n.name=i.find(":input[name=name]").val(),i.find(".sdekint-rule-conditions-list .sdekint-rule-conditions-list-item").each(function(){n.conditions.push(function(t){var e=t.find(":input.sdekint-rule-condition-select").val(),i={type:e},n=function(t,e){return e.find(".condition-type-"+t).first()}(e,t);switch(n.hasClass("sdekint-has-comparison")&&r.extend(i,{comparison:function(t){return t.find(".condition-type-comparison").val()}(n)}),e){case"country":return r.extend(i,{value:n.find(".condition-type-country-country-select").val()});case"region":return r.extend(i,{value:{country:n.find(".condition-type-region-country-select").val(),region:n.find(".condition-type-regions-region:visible").val()}});case"city_name":var s=n.find(".condition-type-city_name-country-select").val(),o=n.find(".condition-type-city_name-region-select").val();return r.extend(i,{value:{country:"0"===s?null:s,region:"0"!==s&&"0"!==o&&o.length?o:null,city:n.find(".condition-type-city_name-city_input").val()}});case"city_sdek":return r.extend(i,{value:n.find(".condition-type-city_sdek-city-select").val()});case"order_weight":return r.extend(i,{value:n.find(".condition-type-order_weight-value").val()});case"order_price":return r.extend(i,{value:n.find(".condition-type-order_price-value").val()})}}(r(this)))}),n.condition_join_type=i.find(".sdekint-rule-conditions-join-type-select").val(),r.each(["courier","point"],function(t,e){n[e]=s(e,i)}),n.methods="all","selected"===i.find(":input[name=methods_select]").val()&&(n.methods=[],i.find('input[type=checkbox][name="selected_method[]"]:checked').each(function(){n.methods.push(this.value)})),r.shop.trace("Condition save",n);var e=i.find("div.field div.submit.value");return e.append('<span><i class="icon16 loading"></i>Сохранение</span>'),e.find(":input[type=submit]").prop("disabled",!0),r.shop.jsonPost("?plugin=sdekint&module=shipping&action=save",{data:JSON.stringify(n)},function(t){t.data.id&&i.find(":input[name=id]").val(t.data.id),e.append('<span class="success green">Сохранено</span>'),setTimeout(function(){e.find("span.success").remove()},3e3)}).always(function(){e.find("i.loading").closest("span").remove(),e.find(":input[type=submit]").prop("disabled",!1)}),!1}),r(".condition-type-city_sdek:visible").each(function(){var t=r(this),e=t.find(".condition-type-city_sdek-city-select").first();if(!e.hasClass("select2-hidden-accessible")){var i=t.find(".condition-type-city_sdek-country-select");e.select2({theme:"sdekint",ajax:{url:"?plugin=sdekint&module=cities&action=index",data:function(t){return{country:i.val(),term:t.term}},delay:350,processResults:r.sdekint.Select2.formatCities},minimumInputLength:2}).on("select2:opening",function(){setTimeout(function(){r("html,body").trigger("scroll")},1)})}})}.bind(this))}}(jQuery),function(o){o.sdekint=o.sdekint||{},o.sdekint.Calculator=function(t){var e=function(t){return{plugin:"sdekint",module:"cities",action:"index",country:this.$countryFrom.val(),term:t.term}}.bind(this),i=function(t){return{plugin:"sdekint",module:"cities",action:"index",country:this.$countryTo.val(),term:t.term}}.bind(this),n=function(){var t=new ymaps.Map("sdekint-map-control",{center:[55.76,37.64],zoom:7,controls:["geolocationControl","trafficControl","typeSelector","zoomControl"]});this.geoCollection=o.sdekint.Ymaps.geocodeSdekPoints(this.point_list,this.balloon_content),t.geoObjects.add(this.geoCollection),t.setBounds(this.geoCollection.getBounds(),{checkZoomRange:!0})}.bind(this),s=function(){var t=o("#s-sdekint-calculator-form"),e={params:{from_city:_.toNumber(o("#s-sdekint-city-from").val()),to_city:_.toNumber(o("#s-sdekint-city-to").val()),packages:[{length:o.sdekint.Utils.formatIntNumber(t.find(":input[name=sizeX]").val(),5),width:o.sdekint.Utils.formatIntNumber(t.find(":input[name=sizeY]").val(),5),height:o.sdekint.Utils.formatIntNumber(t.find(":input[name=sizeZ]").val(),5),weight:o.sdekint.Utils.formatNumber(t.find(":input[name=weight]").val(),.5)}]}};return o.shop.getJSON("?plugin=sdekint&module=tariffs&action=get",e,function(t){var e={tariffs:t.data.tariffs||[],cityTo:o("#s-sdekint-city-to").select2("data")[0]};e.hasPoints=-1!==e.tariffs.findIndex(function(t){return"stock"===t.to});var i=this.template_result.render(e,{stringify:function(t){return JSON.stringify(t,null,2)},daysOfDelivery:function(t,e){return t===e?t:t+"&ndash;"+e},humanizeDelivery:function(t){switch(t){case"door":return"дверь";case"stock":return"склад"}return"??"}});o("#s-sdekint-tariffs-container").html(i)}.bind(this),function(t){var e=this.template_errors.render(t);return o("#s-sdekint-tariffs-container").html(e),o("#city-to-info").hide(),!1}.bind(this))}.bind(this);this.data=t||{},this.wa_url=t.wa_root_url||"/";this.point_list=[],this.geoCollection=!1,o.views.helpers("monetary",function(t){return o.sdekint.Utils.monetary(o.sdekint.Utils.formatNumber(t))}),this.template_result=o.templates("#CalcResult"),this.template_to_city=o.templates("#CityToTemplate"),this.template_errors=o.templates("#CalcErrorsTemplate"),this.$form=o("#s-sdekint-calculator-form"),this.balloon_content=o.templates("#BalloonContent"),o.fn.select2.defaults.set("theme","sdekint"),this.$countryFrom=o("#s-sdekint-country-from").select2({data:o.sdekint.Select2.countryOptions(t.countries),minimumResultsForSearch:1/0,templateResult:function(t){return o.sdekint.Select2.formatCountry(t,this.wa_url)}.bind(this)}),this.$cityFrom=o("#s-sdekint-city-from").select2({ajax:{url:"",data:e,delay:250,processResults:o.sdekint.Select2.formatCities},minimumInputLength:2}),this.$countryTo=o("#s-sdekint-country-to").select2({data:o.sdekint.Select2.countryOptions(t.countries),minimumResultsForSearch:1/0,templateResult:function(t){return o.sdekint.Select2.formatCountry(t,this.wa_url)}.bind(this)}),this.$cityTo=o("#s-sdekint-city-to").select2({ajax:{url:"",data:i,delay:250,processResults:o.sdekint.Select2.formatCities},minimumInputLength:2}).change(function(){this.cityTo=this.$cityTo.select2("data")[0];var t=this.template_to_city.render({city:this.cityTo},{humanize:o.sdekint.Select2.readableCity});o("#city-to-info").html(t).show(),o("#s-sdekint-tariffs-container").empty()}.bind(this)),this.$form.on("change",function(){this.$form.find(":input[type=submit]").prop("disabled",!this.$cityFrom.val()||!this.$cityTo.val())}.bind(this)),o("#s-sdekint-content").off().on("submit","#s-sdekint-calculator-form",function(){return s(),!1}.bind(this)).on("click",".sdekint-point-map-btn",function(t){var e=o('<i class="icon16 loading"></i>').insertAfter(t.target);new o.sdekint.Dialog({html:o("#MapDialogTemplate").render(),onOpen:function(t,e){o.when(o.sdekint.Ymaps.load(),o.sdekint.Http.loadPointsByCity(this.cityTo.id,null,function(t){this.point_list=t.data.office_list}.bind(this))).done(function(){e.$block.find(".sdekint-dialog-content:first").html('<div id="sdekint-map-control" style="width: 100%; height: 100%;"></div>'),e.resize(function(t,e,i,n,s,o){if(!t)throw"Current width and height must be positive integers!";e=_.toNumber(e);var a=(t=Math.min(Math.max(_.toNumber(t),_.toNumber(e)),n))*_.toNumber(o),r=a;if((a<i||s<a)&&e<t){var d=(a=Math.min(Math.max(a,i),s))/o;e<=d&&d<=n&&(t=d,r=a)}return{width:_.toInteger(t),height:_.toInteger(r)}}(.6*o(window).width(),480,360,.75*o(window).width(),.75*o(window).height(),.75)),setTimeout(n,150)}),e.$block.on("click",".sdekint-dialog-close-button a",function(){e.close()})}.bind(this),onResize:function(t,e){setTimeout(function(){e.$block.find(".sdekint-dialog-content:first").css({height:e.$block.height()-24+"px"})},120)},onClose:function(){e.remove()}});return!1}.bind(this))}}(jQuery),function(r){r.sdekint=r.sdekint||{},r.extend(r.sdekint,{Office:function(t){this.map=null,this.points=[],this.geoCollection=null,this.balloon_content=r.templates("#BalloonContent"),this.list_items_tpl=r.templates("#ListItems"),this.wa_url=this.wa_url=t.wa_root_url||"/",r.fn.select2.defaults.set("theme","sdekint"),this.$city=r("#s-sdekint-city").select2({ajax:{url:"",data:function(t){return{plugin:"sdekint",module:"cities",action:"index",with_stocks:1,country:this.$country.val(),term:t.term}}.bind(this),processResults:r.sdekint.Select2.formatCities},minimumInputLength:2}),this.$country=r("#s-sdekint-country").select2({data:r.sdekint.Select2.countryOptions(t.countries||[]),minimumResultsForSearch:1/0,templateResult:function(t){return r.sdekint.Select2.formatCountry(t,this.wa_url)}.bind(this)}),this.$city.on("change",function(){_.isEmpty(this.$city.val())||r.when(r.sdekint.Ymaps.load(),r.sdekint.Http.loadPointsByCity(this.$city.val(),!1,function(t){this.points=t.data.office_list}.bind(this))).done(function(){ymaps.ready(function(){_.isEmpty(this.map)&&(this.map=new ymaps.Map("s-sdekint-map",{center:[55.76,37.64],zoom:7,controls:["geolocationControl","trafficControl","typeSelector","zoomControl"]})),this.geoCollection=r.sdekint.Ymaps.geocodeSdekPoints(this.points,this.balloon_content),this.map.geoObjects.add(this.geoCollection),this.map.setBounds(this.geoCollection.getBounds(),{checkZoomRange:!0});var t=r("#s-sdekint-list");t.html(this.list_items_tpl.render({points:this.points})),this.points.length?t.addClass("bordered"):t.removeClass("bordered")}.bind(this))}.bind(this))}.bind(this));var e=r("#s-sdekint-map"),i=e.width(),n=e.height(),s=e.offset().top,o=r(window).height(),a=Math.max(n,.75*i);r.shop.trace("Offices map",{height:a,sum:s+a}),o-40<s+a&&(a=Math.max(n,o-40-s)),e.css("height",a+"px"),r("#s-sdekint-list").css("height",a+"px")}})}(jQuery),function(o){o.sdekint=o.sdekint||{},o.sdekint.Pickup=function(t,e){this.order=e||{},this.$form=o("#s-sdekint-pickup-form"),this.$city=o("#s-sdekint-city"),this.$points=o("#s-sdekint-office-code"),this.$pickup_date=o("#s-sdekint-pickup-date");var i=function(){var n={number:this.$form.find('input[name="data[order][act_number]"]').val(),order:{number:this.$form.find('input[name="data[order][number]"]').val(),send_city_code:this.$city.val(),pvz_code:o("#s-sdekint-office-code").val(),recipient_name:this.$form.find('input[name="data[order][recipient][name]"]').val(),recipient_phone:this.$form.find('input[name="data[order][recipient][phone]"]').val(),package:[]},call_courier:{date:this.$pickup_date.val(),time_beg:o("#s-sdekint-from-time").val(),time_end:o("#s-sdekint-to-time").val(),send_phone:o('input[name="data[contact][phone]"]').val(),send_address:{sender_name:o('input[name="data[contact][name]"]').val(),street:o('input[name="data[call][send_address][street]"]').val(),house:o('input[name="data[call][send_address][house]"]').val(),flat:o('input[name="data[call][send_address][flat]"]').val()}},profile:{id:o(':input[name="profile[sender][id]"]').val(),save:o('input[name="profile[sender][action][save]"]').is(":checked"),set_default:o('input[name="profile[sender][action][set_default]"]').is(":checked")}};return o.each(this.order.packages,function(t,e){var i={number:e.number||"",bar_code:e.barcode||"",weight:_.toNumber((e.weight+"").replace(",",".")),size_a:_.toNumber(e.size.a),size_b:_.toNumber(e.size.b),size_c:_.toNumber(e.size.c),item:[]};o.each(e.items,function(t,e){i.item.push({ware_key:e.sku||"",cost:_.toNumber((e.price+"").replace(",",".")),payment:_.toNumber((e.payment+"").replace(",",".")),weight:_.toNumber((e.weight+"").replace(",",".")),amount:_.toInteger(e.amount),comment:e.name||""})}.bind(this)),n.order.package.push(i)}.bind(this)),n.call_courier.send_city_code=n.order.rec_city_code=n.order.send_city_code,n}.bind(this),n=function(t){if(t.errors){_.isArray(t.errors)||(t.errors=["Ошибка"]);var e=this.$form.find("div.field.errors").first();e.html(o("#ErrorsBlock").render({errors:t.errors})),setTimeout(function(){e.slideUp(400,function(){e.empty()})},5e3)}return!1}.bind(this);(function(){o.fn.select2.defaults.set("theme","sdekint"),this.$city.select2({ajax:{url:"",data:function(t){return{plugin:"sdekint",module:"cities",action:"index",with_stocks:1,country:"rus",term:t.term}},processResults:o.sdekint.Select2.formatCities},minimumInputLength:2}),this.$points.select2(),this.$city.on("change",function(){o.sdekint.Http.loadPointsByCity(this.$city.val(),!1,function(t){this.$points.empty(),o.each(t.data.office_list,function(t,e){this.$points.append(new Option(e.name,e.code))}.bind(this))}.bind(this))}.bind(this)),this.$pickup_date.datepicker({dateFormat:"yy-mm-dd",minDate:this.$pickup_date.data("min-date")}),this.$form.find("input.s-sdekint-timepicker").each(function(t,e){(e=o(e)).timepicker({format:e.data("format"),minTime:e.data("min-time"),maxTime:e.data("max-time"),step:e.data("step")})}),this.$form.off(".sdekint").on("change.sdekint",'select[name="profile[sender][id]"]',function(t){var e=o(t.currentTarget),i=e.val(),n=_.find(e.find("option"),function(t){return t.value==i});if(o("span.sender-data-new").toggle(!i),o("span.sender-data-existing").toggle(!!i),n){var s=o(n);o('input[name="data[contact][name]"]').val(s.data("name")),o('input[name="data[contact][phone]"]').val(s.data("phone")),o('input[name="data[call][send_address][street]"]').val(s.data("street")),o('input[name="data[call][send_address][house]"]').val(s.data("house")),o('input[name="data[call][send_address][flat]"]').val(s.data("flat")),o('input[name="profile[sender][action][save]"]').prop("checked",!1),o('input[name="profile[sender][action][set_default]"]').prop("checked",!!s.data("is-default"))}}),this.$form.find('select[name="profile[sender][id]"]').trigger("change")}).bind(this)(),o.templates("#PackagesFieldTmpl").link("#s-sdekint-packages",this.order),this.$form.on("click",".js-action.add-package-item",function(t){return o.observable(o.view(this).parent.data.items).insert({sku:"",name:"Товары интернет-магазина",price:0,payment:0,weight:.5,amount:1}),!1}).on("click",".js-action.delete-package-item",function(){var t=o.view(this);return o.observable(t.parent.parent.data).remove(t.getIndex(),1),!1}).on("click",".js-action.add-package",function(){return o.observable(o.view(this).data.packages).insert({number:"1",barcode:"",weight:"0.5",size:{a:5,b:5,c:5},items:[{sku:"",name:"Товары интернет-магазина",price:0,payment:0,weight:.5,amount:1}]}),!1}).on("click",".js-action.delete-package",function(t){var e=o.view(t.currentTarget);return o.observable(e.parent.parent.data).remove(e.getIndex(),1),!1}).on("submit",function(){return this.$form.find(".submit.field .submit.value").append('<span class="loading_message"><i class="icon16 loading"></i>Отправка запроса...</span>'),o.sdekint.Http.pickup.save(i(),function(){o.wa.setHash("couriercalls")},n).always(function(){this.$form.find("span.loading_message").remove()}.bind(this)),!1}.bind(this))}}(jQuery),function(a){a.sdekint=a.sdekint||{},a.sdekint.CourierCalls=function(){this.$table=a.sdekint.$content.find(".couriercalls__list"),this.$table.off(".sdekint-couriercalls").on("click","a.js-action",function(t){var e=a(t.currentTarget),i=e.data("action"),n=e.data("js-confirm");if(!i)return!1;var s="perform"+i.substring(0,1).toUpperCase()+i.substring(1)+"JsAction";if("function"!=typeof this[s])return!1;if(n&&!window.confirm(n))return!1;var o=e.closest(".couriercalls__data-row");return this[s](o),!1}.bind(this)),this.performDeleteJsAction=function(t){var e=t.data("dispatch-number"),i=t.data("order-no"),n=t.data("number-ttn");e&&i&&n?a.sdekint.Http.deletePickup(i,n,function(){window.location.reload()},function(){return!1}):console.error("Invalid data in the row")}}}(jQuery);