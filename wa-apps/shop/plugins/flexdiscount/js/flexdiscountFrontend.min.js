if("undefined"==typeof jQuery){var script=document.createElement("script");script.src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js",document.getElementsByTagName("head")[0].appendChild(script)}var FlexdiscountPluginFrontend=function(t){return(FlexdiscountPluginFrontend=function(e){this.$couponResultField=t(".flexdiscount-coup-result"),this.$couponForm=t(".flexdiscount-form"),this.urls=e.urls||{},this.couponCode=e.couponCode||"",this.locale=e.locale||"",this.settings=e.settings||{},this.shopVersion=parseFloat(e.shopVersion)||0,this.loaderType=e.loaderType||"loader1",this.hideDefaultAffiliateBlock=parseInt(e.hideDefaultAffiliateBlock)||0,this.addAffiliateBlock=parseInt(e.addAffiliateBlock)||0,this.updateInfoblocks=parseInt(e.updateInfoblocks),this.addActiveDiscountsBlock=parseInt(e.addActiveDiscountsBlock)||0,this.ss8forceUpdate=parseInt(e.ss8forceUpdate)||0,this.productIds={},this.wrapElements=[".dialog",".modal",".s-dialog-wrapper"],this.cartTotalElements=[".cart-total",".js-cart-total","#cart-total"],this.cartAffiliateBlock=[".affiliate",".s-affiliate-hint-wrapper",".affiliate-text",".bonus-count"],this.$affiliateHolder=t(".fl-affiliate-holder"),this.$affiliateParentBlock={},this.xhr=this.xhrCart={},this.qtyTimer=null,this.cartTimer=null,this.messages={ru_RU:{"Coupon code is correct":"Купон активирован","Coupon code is incorrect":"Купон не существует"}},this.isOnestepCheckout=this.shopVersion>=8&&t("#js-order-cart").length,this.initClass()}).prototype.initClass=function(){var t=this;t.$couponForm.length&&""!==t.couponCode&&(t.$couponForm.find(".flexdiscount-coupon-code").val(t.couponCode),t.$couponForm.find(".flexdiscount-coup-del-block").show()),t.findAffiliateParent(),t.hideDefaultAffiliateBlock?t.$affiliateParentBlock.remove():t.$affiliateHolder.length&&t.$affiliateHolder.hasClass("fl-hide-block")&&t.$affiliateParentBlock.hide().find(".icon16-flexdiscount").replaceWith(0),t.bindEvents(),t.isOnestepCheckout&&setTimeout(function(){t.initSS8()},500)},FlexdiscountPluginFrontend.prototype.initSS8=function(){if(t("#js-order-page").length){var e=t("#js-order-cart").data("controller");if(void 0!==this.settings.enable_frontend_cart_hook&&parseInt(this.settings.enable_frontend_cart_hook)&&void 0!==e&&e.$coupon_section.length&&(this.$couponForm=t(this.settings.coupon_form),e.$coupon_section.append(this.$couponForm),this.$couponForm.length&&""!==this.couponCode&&(this.$couponForm.find(".flexdiscount-coupon-code").val(this.couponCode),this.$couponForm.find(".flexdiscount-coup-del-block").show())),this.bindSS8(),this.ss8forceUpdate){var o=t("#js-order-form").data("controller");void 0!==o&&o.update()}}},FlexdiscountPluginFrontend.prototype.bindSS8=function(){var e=this;t(document).on("wa_order_cart_rendered","#js-order-cart",function(){e.cartChange()}),t(document).on("wa_order_form_changed","#js-order-form",function(){e.ss8forceUpdate&&e.cartChange()})},FlexdiscountPluginFrontend.prototype.bindEvents=function(){var e=this;t(document).on("click",".flexdiscount-submit-button",function(){var o=t(this),i=o.closest(".flexdiscount-form").find(".flexdiscount-coupon-code"),a=t.trim(i.val());return o.attr("disabled","disabled"),e.addLoading(o),t.post(e.urls.couponAddUrl,{coupon:a},function(t){var i=o.closest("form"),a=i.length?void 0!==i.attr("data-flexdiscount-action")?i.attr("data-flexdiscount-action"):i.attr("action"):"";a=void 0!==a&&""!==a&&"about:blank"!==a?a:location.href,o.removeAttr("disabled"),e.$couponResultField.length?("ok"==t.status?(e.$couponResultField.removeClass("flexdiscount-error").html(e.translate("Coupon code is correct")+" <i class='icon16-flexdiscount loading'></i>"),location.href=a):e.$couponResultField.addClass("flexdiscount-error").html(e.translate("Coupon code is incorrect")),e.removeLoading()):location.href=a},"json"),!1}),t(document).on("click",".flexdiscount-coupon-delete",function(){var o=t(this);return e.hasLoading(o)||(e.addLoading(o),t.post(e.urls.deleteUrl,function(){o.closest(".flexdiscount-coup-del-block").hide().closest(".flexdiscount-form").find(".flexdiscount-coupon-code").val(""),location.reload()},"json")),!1}),t(document).on("change","form, .flexdiscount-product-form",function(){var o=t(this),i=o.find("input[name='product_id']");i.length&&(e.productIds[i.val()]=o,clearTimeout(o.data("flexdiscount-timer")),o.data("flexdiscount-timer",setTimeout(function(){if(!t.isEmptyObject(e.productIds)){var o=e.productIds;e.productIds={},e.updateProductRules(o)}},600)))}),t(document).on("click","a.plus, a.minus, .inc_cart, .dec_cart, .inc_product, .dec_product.dec_product",function(){var o=t(this);clearTimeout(e.qtyTimer),e.qtyTimer=setTimeout(function(){o.closest("form").change()},100)}),t(document).on("wa_order_cart_rendered","#js-order-cart",function(){e.cartChange()}),e.isOnestepCheckout||t(document).ajaxComplete(function(t,o,i){return void 0!==i&&void 0!==i.url&&(e.endsWith(e.urls.cartSaveUrl.shop,i.url)||e.endsWith(e.urls.cartAddUrl.shop,i.url)||e.endsWith(e.urls.cartDeleteUrl.shop,i.url)||e.endsWith(e.urls.cartSaveUrl.plugin,i.url)||e.endsWith(e.urls.cartAddUrl.plugin,i.url)||e.endsWith(e.urls.cartDeleteUrl.plugin,i.url))&&e.cartChange(),!0})},FlexdiscountPluginFrontend.prototype.endsWith=function(t,e){return t.substring(t.length-e.length,t.length)===e},FlexdiscountPluginFrontend.prototype.updateProductRules=function(e){var o=this;if(o.updateInfoblocks){var i=null,a=0,n={},s={},d={},l={},r={},c={};t.each(e,function(e,n){null===i&&(i=e);var f=n.find("input[name='quantity']").val();f=f||1;var p=o.findWrap(n);s[e]=p.find(".flexdiscount-available-discount.product-id-"+e);var h=u(s[e]);d[e]=p.find(".flexdiscount-product-discount.product-id-"+e);var v=u(d[e]);l[e]=p.find(".flexdiscount-price-block.product-id-"+e);var m=u(l[e]);r[e]=p.find(".flexdiscount-deny-discount.product-id-"+e);var g=u(r[e]);c[e]={quantity:f,available_discounts:h,p_discounts:v,price_blocks:m,deny_discounts:g,params:n.serialize()},void 0===o.xhr[e]||t.isEmptyObject(o.xhr[e])||4==o.xhr[e].readyState||o.xhr[e].abort(),a++}),1===a&&(n=o.xhr),n[i]=t.ajax({type:"post",url:o.urls.updateDiscountUrl,cache:!1,dataType:"json",beforeSend:function(t){1===a&&(o.xhr[i]=t)},data:{products:c},success:function(e){"ok"==e.status&&e.data&&void 0!==e.data.products?t.each(e.data.products,function(t,i){o.updateDiscountBlocks(s[t],"available_discounts",i,t,e),o.updateDiscountBlocks(d[t],"p_discounts",i,t,e),o.updateDiscountBlocks(l[t],"price_blocks",i,t,e),o.updateDiscountBlocks(r[t],"deny_discounts",i,t,e)}):o.removeLoader(t(document))},error:function(e,i,a){"abort"!==i&&(console&&console.log(e,i,a),o.removeLoader(t(document)))},complete:function(){delete n[i]}})}function u(e){var i={};return e.length&&e.each(function(){var e=t(this),a=e.hasClass("f-update-sku")?"find":e.attr("data-sku-id"),n=void 0!==e.attr("data-view-type")?e.attr("data-view-type"):0;void 0===i[a]&&(i[a]={}),i[a][n]=e.hasClass("flexdiscount-available-discount")&&void 0!==e.attr("data-filter-by")?e.attr("data-filter-by"):n,o.addLoader(e)}),i}},FlexdiscountPluginFrontend.prototype.updateAllRules=function(e){var o=this;if(o.updateInfoblocks){var i=(e=e||t(document)).find(".flexdiscount-available-discount"),a=e.find(".flexdiscount-product-discount"),n=e.find(".flexdiscount-price-block"),s=e.find(".flexdiscount-deny-discount"),d=function(e){var i={};return e.length&&e.each(function(){var e=t(this),a=e.hasClass("flexdiscount-available-discount")?"available_discounts":e.hasClass("flexdiscount-product-discount")?"p_discounts":e.hasClass("flexdiscount-price-block")?"price_blocks":e.hasClass("flexdiscount-deny-discount")?"deny_discounts":"",n=void 0!==e.attr("data-product-id")?parseInt(e.attr("data-product-id")):0;if(n>0&&""!==a){if(void 0===i[n]){var s=o.findWrap(e,""),d=s.length?s.find("form"):e;i[n]={quantity:d.find("input[name='quantity']").length?d.find("input[name='quantity']").val():1,available_discounts:{},p_discounts:{},price_blocks:{},deny_discounts:{},params:d.serialize()}}var l=e.hasClass("f-update-sku")?"find":e.attr("data-sku-id"),r=void 0!==e.attr("data-view-type")?e.attr("data-view-type"):0;void 0===i[n][a][l]&&(i[n][a][l]={}),i[n][a][l][r]=e.hasClass("flexdiscount-available-discount")&&void 0!==e.attr("data-filter-by")?e.attr("data-filter-by"):r,o.addLoader(e)}}),i}(i.add(a).add(n).add(s));t.isEmptyObject(o.xhr)||4!=o.xhr.readyState&&o.xhr.abort(),o.xhr=t.ajax({type:"post",url:o.urls.updateDiscountUrl,cache:!1,dataType:"json",data:{products:d},success:function(e){"ok"==e.status&&e.data&&void 0!==e.data.products?t.each(e.data.products,function(t,d){o.updateDiscountBlocks(i.filter(".product-id-"+t),"available_discounts",d,t,e),o.updateDiscountBlocks(a.filter(".product-id-"+t),"p_discounts",d,t,e),o.updateDiscountBlocks(n.filter(".product-id-"+t),"price_blocks",d,t,e),o.updateDiscountBlocks(s.filter(".product-id-"+t),"deny_discounts",d,t,e)}):o.removeLoader(t(document))},error:function(e,i,a){"abort"!==i&&(console&&console.log(e,i,a),o.removeLoader(t(document)))},complete:function(){o.xhr={}}})}},FlexdiscountPluginFrontend.prototype.removeLoading=function(){var e=t(".icon16-flexdiscount.loading");e.length&&e.remove()},FlexdiscountPluginFrontend.prototype.addLoading=function(t){t.after("<i class='icon16-flexdiscount loading'></i>")},FlexdiscountPluginFrontend.prototype.hasLoading=function(t){return!!t.next(".icon16-flexdiscount.loading").length},FlexdiscountPluginFrontend.prototype.hideLoading=function(t){t.next(".icon16-flexdiscount.loading").remove()},FlexdiscountPluginFrontend.prototype.addLoader=function(t){switch(this.removeLoader(t),this.loaderType){case"loader1":var e='<div class="align-center flexdiscount-loader" style="display: block"><i class="flexdiscount-big-loading"></i></div>';t.find(".flexdiscount-interactive").length?t.find(".flexdiscount-interactive").hide().before(e):(t.children().hide(),t.append(e));break;case"loader2":t.addClass("fl-is-loading");break;case"loader3":t.addClass("fl-is-loading fl-loader-2")}},FlexdiscountPluginFrontend.prototype.removeLoader=function(t){"loader1"==this.loaderType?(t.find(".flexdiscount-interactive").length?t.find(".flexdiscount-interactive").show():t.children().show(),t.find(".flexdiscount-loader").remove()):t.removeClass("fl-is-loading fl-loader-2")},FlexdiscountPluginFrontend.prototype.updateDiscountBlocks=function(e,o,i,a,n){var s=this;e&&e.length&&e.each(function(){var e=t(this),d=e.hasClass("f-update-sku")?n.data.product_skus[a]:e.attr("data-sku-id"),l=void 0!==e.attr("data-view-type")?e.attr("data-view-type"):0;void 0!==i[d]&&void 0!==i[d][o]&&void 0!==i[d][o][l]&&(e.html(t(i[d][o][l]).html()),t(i[d][o][l]).hasClass("flexdiscount-show")?e.css("display",""):t(i[d][o][l]).hasClass("flexdiscount-hide")&&e.hide(),e.hasClass("f-update-sku")&&e.attr("data-sku-id",d)),s.removeLoader(e)})},FlexdiscountPluginFrontend.prototype.findWrap=function(e,o){var i=e.closest(".flexdiscount-product-wrap, .igaponov-product-wrap"+(this.wrapElements.length?", "+this.wrapElements.join(","):""));if(!i.length){var a=e.closest(".s-products-list, .product-list, .lazy-wrapper, ul.thumbnails, .product-thumbs, .product-list");a.length&&(i=t("> li, > div, > tr",a)),i.length&&i.addClass("igaponov-product-wrap")}return i.length?i:void 0!==o?o:t(document)},FlexdiscountPluginFrontend.prototype.cartChange=function(){var e=this;var o=t(".flexdiscount-cart-price"),i=t(".flexdiscount-user-discounts, .flexdiscount-user-affiliate"),a={fields:{},user_discounts:{},affiliate_block:{}},n=1;e.hideLoading(o),clearTimeout(e.cartTimer),e.cartTimer=setTimeout(function(){o.length&&(o.each(function(e){var o=t(this);o.length&&(o.addClass("c"+e),void 0===a.fields[o.data("cart-id")]&&(a.fields[o.data("cart-id")]={}),a.fields[o.data("cart-id")]["c"+e]={mult:o.data("mult"),html:o.data("html"),format:o.data("format")})}),e.addLoading(o),n=0),i.length&&(i.each(function(){var o=t(this),i=o.hasClass("flexdiscount-user-discounts")?"user_discounts":"affiliate_block";if("discounts"==i&&o.parent(".quickorder-fl-ad").length)return!0;a[i][o.attr("data-view-type")]=o.attr("data-view-type"),e.addLoader(o)}),n=0),!e.$affiliateParentBlock.length||e.hideDefaultAffiliateBlock||e.isOnestepCheckout||e.$affiliateParentBlock.each(function(e,o){var i=(o=t(o)).find("strong");i.length?(i.html(i.html().replace(/\+\s*\d+\.?\d*/,'<i class="icon16-flexdiscount loading fl-replace-affiliate"></i>')),n=0):-1!==o.text().search(/\+\s*\d+\.?\d*/)&&(o.html(o.html().replace(/\+\s*\d+\.?\d*/,'<i class="icon16-flexdiscount loading fl-replace-affiliate"></i>')),n=0)}),n||(t.isEmptyObject(e.xhrCart)||4!=e.xhrCart.readyState&&e.xhrCart.abort(),e.xhrCart=t.ajax({type:"post",url:e.urls.refreshCartUrl,cache:!1,dataType:"json",data:{data:a},success:function(i){var a,n;e.hideLoading(o),"ok"==i.status&&i.data&&(void 0!==i.data.fields&&t.each(i.data.fields,function(e,o){t(o.elem).removeClass(o.removeClass).html(t(o.price).html())}),void 0!==i.data.blocks&&(a=i.data.blocks,!(n=t(".flexdiscount-user-discounts, .flexdiscount-user-affiliate")).length||void 0===a.discounts&&void 0===a.affiliate||n.each(function(){var e=t(this),o=e.hasClass("flexdiscount-user-discounts")?"discounts":"affiliate";if("discounts"==o&&e.parent(".quickorder-fl-ad").length)return!0;void 0!==a[o][e.attr("data-view-type")]&&e.replaceWith(a[o][e.attr("data-view-type")])}),e.removeLoader(n)),t(".fl-replace-affiliate").length&&!e.hideDefaultAffiliateBlock&&(void 0!==i.data.clear_affiliate&&0!==i.data.clear_affiliate?(t(".fl-replace-affiliate").siblings(".fl-affiliate-holder").remove().end().replaceWith("+"+i.data.clear_affiliate+'<span class="fl-affiliate-holder" style="display:none"></span>'),e.findAffiliateParent().show()):(t(".fl-replace-affiliate").siblings(".fl-affiliate-holder").remove().end().replaceWith('+0 <span class="fl-affiliate-holder" style="display:none"></span>'),e.findAffiliateParent().hide())))},error:function(o,i,a){"abort"!==i&&(console&&console.log(o,i,a),t(".fl-replace-affiliate").length&&!e.hideDefaultAffiliateBlock&&e.findAffiliateParent().hide())},complete:function(){e.xhrCart={}}}))},100)},FlexdiscountPluginFrontend.prototype.findAffiliateParent=function(){var e=this;if(e.$affiliateParentBlock=t(),e.isOnestepCheckout){var o=t("#js-order-cart").data("controller");void 0!==o&&o.$affiliate_section.length&&(e.$affiliateParentBlock=o.$affiliate_section.find("#wa-affiliate-order-bonus"))}else{var i=e.cartAffiliateBlock.length?t(""+e.cartAffiliateBlock.join(",")):"";t(".fl-affiliate-holder").each(function(){var o=t(this).closest(i);o.length||(o=t(this).parent()).is("strong")&&(o=o.parent()),e.$affiliateParentBlock=e.$affiliateParentBlock.add(o)})}return e.$affiliateParentBlock},FlexdiscountPluginFrontend.prototype.translate=function(t){return void 0!==this.messages[this.locale]&&this.messages[this.locale][t]?this.messages[this.locale][t]:t},FlexdiscountPluginFrontend}(jQuery);