var Metrika=(function(){handlers={getMetrika:function(){var action=$(this).data("action");var source=$(this).data("source");if(source===undefined){interfaceMetrika.clearMenu($(this),$(this).html());interfaceMetrika.loadingIcon(true);interfaceMetrika.clearContent();}else{interfaceMetrika.loadingIconDetail($(this),true);}$.ajax({type:"GET",url:"?plugin=metrika&action=get&date_start="+getDate("start")+"&date_end="+getDate("end")+"&type="+action,dataType:"json",contentType:"application/json",cache:true,success:function(serverAnswer){if(serverAnswer.status=="ok"){graph.getGraph(action,serverAnswer);}else{interfaceMetrika.showError(serverAnswer);}},error:function(xhr){console.log(xhr.responseText);}});return false;},getHelp:function(){$(this).hide();$(this).closest(".block").find("ul li").show();return false;},saveToken:function(){$.ajax({type:"GET",url:"?plugin=metrika&action=savetoken&code="+$(this).prev("input").val(),dataType:"json",contentType:"application/json",success:function(json){if(json.status=="fail"){error="";jQuery.each(json.errors,function(i,val){error=error+val[0];});alert(error);}if(json.status=="ok"){$(".error").hide();$(".metrika-menu li:first a").click();}}});}},interfaceMetrika={clearMenu:function(menu,name){$(".metrika-menu li").removeClass("selected");menu.parent("li").addClass("selected");$(".metrika-name").html(name);$(".error").hide();interfaceMetrika.loadingIcon(false);},clearContent:function(){$("#chart_summary").html("");$(".stat_table").hide();$(".load_data").remove();$(".load_data_detail").remove();},loadingIcon:function(loadingType){var loading_container=$("#period-description");var loading_img='<img class="loading" src="/wa-content/img/loading16.gif"/>';if(loadingType){loading_container.after(loading_img);}else{$(".loading").remove();}},loadingIconDetail:function(thisplace,loadingType){var loading_container=$(thisplace);var loading_img='<img class="loading" src="/wa-content/img/loading16.gif"/>';if(loadingType){loading_container.after(loading_img);}else{$(".loading").remove();}},showError:function(serverAnswer){interfaceMetrika.loadingIcon(false);error="";jQuery.each(serverAnswer.errors,function(i,val){error=error+val[0];});$(".metrika-content .error").show().html(error);}},graph={getGraph:function(action,json){var totals_visits=0,more=0;var summary=[];var source=[];var visits=[];var views=[];var date=[];interfaceMetrika.loadingIcon(false);switch(action){case"traffic":$(".type-1").show();$.each(json.data.data,function(index,value){if(value.name){$(".type-1 .zebra").append('<tr class="load_data"><td>'+value.name.substring(0,100)+"</td><td>"+value.visits+"</td><td>"+value.page_views+"</td><td>"+value.new_visitors_count+" ("+value.new_visitors+")</td><td>"+value.depth+"</td><td>"+value.denial+"</td></tr>");}summary[index]=[value.name.substring(0,100),value.visits];visits[index]=[value.visits];views[index]=[value.page_views];date[index]=[value.name];});var visits=visits.reverse();var views=views.reverse();var date=date.reverse();$(".type-1 .totals_visits").html(json.data.totals_visits);$(".type-1 .totals_page_view").html(json.data.totals_page_views);$(".type-1 .totals_new_visitors").html(json.data.totals_new_visitors);$(".type-1 .totals_new_visitors_count").html(json.data.totals_new_visitors_count);$(".type-1 .totals_depth").html(json.data.totals_depth);$(".type-1 .totals_denial").html(json.data.totals_denial);barChart(summary.reverse(),date,visits,views);break;case"sources":$(".type-2").show();$.each(json.data,function(index,value){if(value.name){if(value.id=="direct"||value.id=="saved"||value.id=="internal"){$(".type-2 .zebra").append('<tr class="load_data"><td>'+value.name.substring(0,100)+"</td><td>"+value.visits+"</td><td>"+value.users+"</td><td>"+value.bounceRate+"</td><td>"+value.pageDepth+"</td><td>"+value.avgVisitDurationSeconds+"</td></tr>");}else{$(".type-2 .zebra").append('<tr class="load_data"><td><a href="" class="inline-link source" data-action="'+value.id+'" data-source="'+value.id+'"><b>'+value.name.substring(0,100)+"</b></a></td><td>"+value.visits+"</td><td>"+value.users+"</td><td>"+value.bounceRate+"</td><td>"+value.pageDepth+"</td><td>"+value.avgVisitDurationSeconds+"</td></tr>");}}if(index<=9){totals_visits=totals_visits+value.visits;source[index]=[value.name.substring(0,100),value.visits];more=more+value.visits;}else{if(index==10){source[index]=["Другие",totals_visits-more];}}});pieChartPercent(source);break;case"conversion":$(".type-3").show();$.each(json.data,function(index,value){if(value.name){$(".type-3 .zebra").append('<tr class="load_data"><td>'+value.name.substring(0,100)+"</td><td>"+value.visits+"</td><td>"+value.users+"</td><td>"+value.pageViews+"</td><td>"+value.conversion+"</td></tr>");}if(index<=9){totals_visits=totals_visits+value.visits;source[index]=[value.name.substring(0,100),value.visits];more=more+value.visits;}else{if(index==10){source[index]=["Другие",totals_visits-more];}}});pieChartPercent(source);break;case"phrases":$(".type-2").show();$.each(json.data,function(index,value){if(value.name){$(".type-2 .zebra").append('<tr class="load_data"><td><img src="https://favicon.yandex.net/favicon/'+value.favicon+'/"> '+value.name.substring(0,100)+'<a href="'+value.url+'" target="_blank"><i class="icon16 new-window"></i></a></td><td>'+value.visits+"</td><td>"+value.users+"</td><td>"+value.bounceRate+"</td><td>"+value.pageDepth+"</td><td>"+value.avgVisitDurationSeconds+"</td></tr>");}if(index<=9){totals_visits=totals_visits+value.visits;source[index]=[value.name.substring(0,100),value.visits];more=more+value.visits;}else{if(index==10){source[index]=["Другие",totals_visits-more];}}});pieChartPercent(source);break;case"popular":$(".type-4").show();$.each(json.data,function(index,value){if(value.name){$(".type-4 .zebra").append('<tr class="load_data"><td>'+value.name.substring(0,100)+'<a href="'+value.name+'" target="_blank"><i class="icon16 new-window"></i></a></td><td>'+value.users+"</td><td>"+value.pageViews+"</td><td>"+value.pageDepth+"</td></tr>");}if(index<=9){totals_visits=totals_visits+value.users;source[index]=[value.name.substring(0,100),value.users];more=more+value.users;}else{if(index==10){source[index]=["Другие",totals_visits-more];}}});pieChartPercent(source);break;case"ad":case"organic":case"referral":case"social":interfaceMetrika.loadingIconDetail(false);var place=$("a[data-source='"+action+"']").closest("tr");$(".load_data_detail").remove();$.each(json.data.reverse(),function(index,value){if(value.name){if(action=="referral"){place.after('<tr class="load_data_detail"><td><span>'+value.name.substring(0,100)+'</span><a href="'+value.name+'" target="_blank"><i class="icon16 new-window"></i></a></td><td>'+value.visits+"</td><td>"+value.users+"</td><td>"+value.bounceRate+"</td><td>"+value.pageDepth+"</td><td>"+value.avgVisitDurationSeconds+"</td></tr>");}else{place.after('<tr class="load_data_detail"><td><span>'+value.name.substring(0,100)+"</span></td><td>"+value.visits+"</td><td>"+value.users+"</td><td>"+value.bounceRate+"</td><td>"+value.pageDepth+"</td><td>"+value.avgVisitDurationSeconds+"</td></tr>");}}});break;case"geo":case"demography":case"age_gender":case"os":case"browsers":case"mobile":case"devices":case"tech_display":case"interests":$(".type-2").show();$.each(json.data,function(index,value){if(value.name){$(".type-2 .zebra").append('<tr class="load_data"><td>'+value.name.substring(0,100)+"</td><td>"+value.visits+"</td><td>"+value.users+"</td><td>"+value.bounceRate+"</td><td>"+value.pageDepth+"</td><td>"+value.avgVisitDurationSeconds+"</td></tr>");if(index<=9){totals_visits=totals_visits+value.visits;source[index]=[value.name.substring(0,100),value.visits];more=more+value.visits;}else{if(index==10){source[index]=["Другие",totals_visits-more];}}}});pieChartPercent(source);break;default:}}},getDate=function(type){var period=($(".s-reports-timeframe-dropdown .menu-v").find("li.selected").data("timeframe"));var period_text=$(".s-reports-timeframe-dropdown").find("i").html();if(period=="all"){var start_date=getCustomDate();var end_date=getCustomDate(700);}else{if(period=="custom"){var start_date=$('input[name="to"]').val();var end_date=$('input[name="from"]').val();period_text=end_date+" - "+start_date;}else{var start_date=getCustomDate();var end_date=getCustomDate(period);}}if(type=="end"){date=start_date;}else{date=end_date;}$("#period-description").html(period_text);return date;},getCustomDate=function(offset){if(offset===undefined){offset=0;}var x=new Date(new Date()-offset*1000*60*60*24);var d={day:x.getDate(),month:(x.getMonth()+1),year:x.getFullYear()};var D={};for(var n in d){D[n]=(parseInt(d[n],10)<10)?("0"+d[n]):(d[n]);}var z=D.day+"."+D.month+"."+D.year;return z;},barChart=function(data,date,visits,views){$.jqplot("chart_summary",[data],{seriesColors:["#009900"],seriesDefaults:{renderer:$.jqplot.BarRenderer,shadow:false,rendererOptions:{barMargin:0.5,highlightMouseOver:true,highlightMouseDown:false,highlightColor:"#000"}},grid:{borderWidth:0,background:"#ffffff",gridLineColor:"#f7f7f7",gridLineWidth:1,shadow:false},highlighter:{show:true,showMarker:false,background:"#ffffff",tooltipOffset:0,bringSeriesToFront:true,tooltipContentEditor:function tooltipVisits(str,seriesIndex,pointIndex,plot){return"Дата: "+date[pointIndex]+"<br>Визиты: "+visits[pointIndex]+"<br>Просмотры: "+views[pointIndex];}},axes:{xaxis:{tickRenderer:$.jqplot.CanvasAxisTickRenderer,tickOptions:{fontSize:"12px",autoscale:true,angle:270,labelPosition:"middle"},labelRenderer:$.jqplot.CanvasAxisLabelRenderer,renderer:$.jqplot.CategoryAxisRenderer},yaxis:{rendererOptions:{forceTickAt0:true,forceTickAt100:false},autoscale:true}}});},pieChartPercent=function(data){jQuery.jqplot("chart_summary",[data],{seriesColors:["#009900","#ff3030","#ff7711","#00b6f7","#ffc600","#b311ff","#214d21","#295d9e","#00e34b","#b161b4","#b0b0b0"],grid:{borderWidth:0,background:"#ffffff",gridLineColor:"#f7f7f7",gridLineWidth:1,shadow:false},seriesDefaults:{renderer:jQuery.jqplot.PieRenderer,rendererOptions:{color:"#ffffff",showDataLabels:true,shadow:false,startAngle:180,substringMargin:1,diameter:250}},legend:{fontSize:"14px",show:true,location:"e"}});},addEventList=function(){$(document).on("click",".metrika-menu a",handlers.getMetrika);$(document).on("click",".load_data a.inline-link",handlers.getMetrika);$(document).on("click",".show-all-help",handlers.getHelp);$(document).on("click",".send-code",handlers.saveToken);};return{init:function(){$(document).ready(function(){addEventList();});}};})();Metrika.init();