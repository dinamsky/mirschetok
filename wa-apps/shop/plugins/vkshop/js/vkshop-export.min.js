$.extend($.importexport.plugins,{vkshop:{$form:null,progress:false,ajax_pull:{},data:{params:{}},debug:{memory:0,memory_avg:0},init:function(a){$.shop.trace("init data",a);this.$form=$("#s-plugin-vkshop");$.extend(this.data,a)},action:function(){},GetcodeAction:function(){},getcodeAction:function(){},onInit:function(){$.importexport.products.init(this.$form);this.$form.unbind("submit.vkshop").bind("submit.vkshop",function(a){$.shop.trace("submit.vkshop "+a.namespace,a);$.importexport.plugins.vkshop.vkshopHandler(this);return false})},actionHandler:function(a){$.shop.trace("actionHadler arg",a);return false},vkshopHandler:function(d){var a=this;a.progress=true;a.form=$(d);var c=a.form.serialize();var b=$(d).attr("action");$.shop.trace("elm",d);a.form.find(".errormsg").text("");a.form.find(":input").prop("disabled",true);a.form.find(":submit").hide();a.form.find(".progressbar .progressbar-inner").css("width","0");a.form.find(".progressbar").show();a.form.find("#plugin-vkshop-report").hide();$.ajax({url:b,data:c,dataType:"json",type:"post",success:function(e){if(e.error){a.form.find(":input").prop("disabled",false);a.form.find(":submit").show();a.form.find(".js-progressbar-container").hide();a.form.find(".shop-ajax-status-loading").remove();a.progress=false;a.form.find(".errormsg").text(e.error)}else{a.form.find(".progressbar").attr("title","0.00%");a.form.find(".progressbar-description").text("0.00%");a.form.find(".js-progressbar-container").show();a.ajax_pull[e.processId]=[];a.ajax_pull[e.processId].push(setTimeout(function(){$.wa.errorHandler=function(f){return !((f.status>=500)||(f.status==0))};a.progressHandler(b,e.processId,e)},100));a.ajax_pull[e.processId].push(setTimeout(function(){a.progressHandler(b,e.processId,null)},2000))}},error:function(){a.form.find(":input").attr("disabled",false);a.form.find(":submit").show();a.form.find(".js-progressbar-container").hide();a.form.find(".shop-ajax-status-loading").remove();a.form.find(".progressbar").hide()}})},progressHandler:function(c,a,g){var k=$.importexport.plugins.vkshop;var f;if(g&&g.ready){$.wa.errorHandler=null;var e;while(e=k.ajax_pull[a].pop()){if(e){clearTimeout(e)}}f=k.form.find(".progressbar .progressbar-inner");f.css({width:"100%"});$.shop.trace("cleanup",g.processId);$.ajax({url:c,data:{processId:g.processId,cleanup:1},dataType:"json",type:"post",success:function(m){$.shop.trace("report",m);k.form.find(".js-progressbar-container").hide();var n=$("#plugin-vkshop-report");n.show();if(m.report){n.find(".value:first").html(m.report)}k.form.find(":input").prop("disabled",false);k.form.find(":submit").show()}})}else{if(g&&g.error){k.form.find(":input").attr("disabled",false);k.form.find(":submit").show();k.form.find(".js-progressbar-container").hide();k.form.find(".shop-ajax-status-loading").remove();k.form.find(".progressbar").hide();k.form.find(".errormsg").text(g.error)}else{var i;if(g&&(typeof(g.progress)!="undefined")){f=k.form.find(".progressbar .progressbar-inner");var b=parseFloat(g.progress.replace(/,/,"."));f.animate({width:b+"%"});k.debug.memory=Math.max(0,k.debug.memory,parseFloat(g.memory)||0);k.debug.memory_avg=Math.max(0,k.debug.memory_avg,parseFloat(g.memory_avg)||0);var j="Memory usage: "+k.debug.memory_avg+"/"+k.debug.memory+"MB";j+=" ("+(1+g.stage_num)+"/"+(0+g.stage_count)+")";var l=g.progress;f.parents(".progressbar").attr("title",g.progress);i=k.form.find(".progressbar-description");i.text(l);i.attr("title",j)}if(g&&(typeof(g.warning)!="undefined")){i=k.form.find(".progressbar-description");i.append('<i class="icon16 exclamation"></i><p>'+g.warning+"</p>")}var h=c;var d=a;k.ajax_pull[d].push(setTimeout(function(){$.ajax({url:h,data:{processId:d},dataType:"json",type:"post",success:function(m){k.progressHandler(c,m?m.processId||d:d,m)},error:function(){k.progressHandler(c,d,null)}})},1000))}}}}});(function(a){a.Vkshop={init:function(){var c=this,d=c.getHashParams(),b=window.location;if(d.code){window.location.hash="#/vkshop/";a.post("?plugin=vkshop&action=vklogin",{group_id:d["/vkshop/getcode/?group"],code:d.code,logout:0},function(e){if(e.status==="ok"){a("#vkshop-login-"+d["/vkshop/getcode/?group"]).html(e.data.login_template);a("#vkshop-export-groups").html(e.data.groups_template);a("#vkshop-albums").html(e.data.albums_template)}},"json")}else{}},logout:function(b){a.post("?plugin=vkshop&action=vklogin",{logout:1,group_id:b},function(c){if(c.status==="ok"){a("#vkshop-login-"+b).html(c.data.login_template)}},"json")},radio:function(c){var b=a(c).val();a(".vkshop-select").hide();if(b=="type"){a("#vkshop-types").show()}if(b=="set"){a("#vkshop-sets").show()}if(b=="queue"){a("#vkshop-vk-album").show();a("#vkshop-vk-new-album").show()}if(b=="all"){a("#vkshop-vk-album").show();a("#vkshop-vk-new-album").show()}},getHashParams:function(){var c={};var h,b=/\+/g,f=/([^&;=]+)=?([^&;]*)/g,i=function(d){return decodeURIComponent(d.replace(b," "))},g=window.location.hash.substring(1);while(h=f.exec(g)){c[i(h[1])]=i(h[2])}return c},groupselect:function(c){var b=a(c).val();a.post("?plugin=vkshop&action=getalbums",{group_id:b},function(e){if(e.status==="ok"){a("#vkshop-albums").html(e.data.albums)}},"json")}}})(jQuery);